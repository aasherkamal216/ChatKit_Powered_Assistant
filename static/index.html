<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatKit Professional Agent</title>
    <!-- Load ChatKit Web Component -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background: #f0f2f5; 
        }
        
        #chat-container { 
            width: 100%; 
            max-width: 600px; 
            height: 90vh; 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* Ensure the custom element fills the container */
        openai-chatkit { 
            display: block; 
            height: 100%; 
            width: 100%; 
        }
    </style>
</head>
<body>

<div id="chat-container">
    <openai-chatkit id="chat"></openai-chatkit>
</div>

<script type="module">
    // 1. Wait for the component to be ready
    await customElements.whenDefined('openai-chatkit');
    const chat = document.getElementById('chat');

    // 2. Identify Unique User (Iframe-safe persistence)
    let userId = localStorage.getItem('chatkit_user_id');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substring(2, 11);
        localStorage.setItem('chatkit_user_id', userId);
    }

    // 3. Mock Data for @-mention Entity Search
    const MOCK_ENTITIES = [
        { id: "order_123", title: "Order #123 (Shipped)", group: "Active Orders", icon: "lucide:package", interactive: true, data: { type: 'order' } },
        { id: "order_456", title: "Order #456 (Processing)", group: "Active Orders", icon: "lucide:clock", interactive: true, data: { type: 'order' } },
        { id: "doc_policy", title: "Return Policy", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } },
        { id: "doc_shipping", title: "Shipping Rates", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } }
    ];

// 4. Define Initial Options
    let currentOptions = {
        api: {
            url: 'http://localhost:8000/chatkit',
            fetch: (url, options) => {
                options.headers = { ...options.headers, 'X-ChatKit-User': userId };
                return fetch(url, options);
            },
            uploadStrategy: { type: 'direct', uploadUrl: 'http://localhost:8000/upload' },
            domainKey: 'local-dev' 
        },
        theme: {
            colorScheme: 'light',
            radius: 'pill',
            typography: {
                baseSize: 16,
                fontFamily: '"OpenAI Sans", system-ui, sans-serif',
                fontFamilyMono: 'ui-monospace, Consolas, monospace',
                fontSources: [
                    {
                        family: 'OpenAI Sans',
                        src: 'https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-Regular.woff2',
                        weight: 400,
                        style: 'normal',
                        display: 'swap'
                    }
                ]
            }
        },
        startScreen: {
            greeting: "Hello! I'm your ProAgent.",
            prompts: [
                { label: "Search AI News", prompt: "Search the web for the latest news on OpenAI ChatKit", icon: "lucide:search" },
                { label: "Analyze Sales", prompt: "Analyze sales performance for North America.", icon: "lucide:bar-chart" },
                { label: "Customize UI", prompt: "I want a new theme. Make it dark mode with a purple neon style and sharp corners.", icon: "lucide:palette" },
                { label: "Check Weather", prompt: "What is the weather in San Francisco?", icon: "lucide:sun" },
                { label: "Generate Image", prompt: "Generate an image of a futuristic city", icon: "lucide:image" },
            ]
        },
        composer: {
            placeholder: "Ask me to search, generate images, or change the UI...",
            dictation: { enabled: true },
            attachments: { enabled: true },
            tools: [
                { id: "web_search", label: "Web Search", icon: "lucide:globe" },
                { id: "get_weather", label: "Weather", icon: "lucide:sun" },
                { id: "preview_theme", label: "Theme Creation", icon: "lucide:paintbrush" }
            ],
            models: [
                { id: "gpt-5-mini", label: "GPT 5 Mini" , default: true },
                { id: "gpt-5.2", label: "GPT 5.2" }
            ]
        },
        history: {
            enabled: true,
            showDelete: true,
            showRename: true
        },
        threadItemActions: {
            retry: true,
            feedback: true
        },
        entities: {
            showComposerMenu: true,
            onTagSearch: async (query) => {
                const q = query.toLowerCase();
                return MOCK_ENTITIES.filter(e => e.title.toLowerCase().includes(q));
            },
            onClick: (entity) => {
                console.log("User clicked entity:", entity);
            },
            onRequestPreview: async (entity) => {
                // Returns a rich preview widget for the entity
                return {
                    preview: {
                        type: 'Basic',
                        children: [
                            { type: 'Title', value: entity.title, size: 'sm' },
                            { type: 'Text', value: `Database ID: ${entity.id}`, size: 'sm', color: 'secondary' },
                            { type: 'Text', value: "Click to open full records in dashboard.", size: 'xs' }
                        ]
                    }
                };
            }
        }
    };

    // 5. Initialize Chat
    chat.setOptions(currentOptions);

    // 6. LISTEN FOR CLIENT EFFECTS
    // This allows the server to change the UI look and feel or trigger local logic.
    chat.addEventListener('chatkit.effect', (event) => {
        const { name, data } = event.detail;
        
        if (name === 'update_ui_theme') {
            console.log("Applying theme with typography:", data);
            
            // 1. Update the local configuration object
            currentOptions = {
                ...currentOptions,
                theme: {
                    ...data,
                    // Ensure typography is explicitly spread
                    typography: data.typography 
                }
            };
            
            // 2. Trigger the SDK update
            chat.setOptions(currentOptions);
            
            // 3. Optional: Force a small layout check to ensure fonts apply
            console.log("Design system refreshed.");
        }
    });

    // Optional: Log errors for debugging
    chat.addEventListener('chatkit.error', (e) => {
        console.error("ChatKit Runtime Error:", e.detail.error);
    });

</script>

</body>
</html>