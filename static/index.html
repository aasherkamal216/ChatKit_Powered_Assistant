<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatKit Professional Agent</title>
    <!-- Load ChatKit Web Component -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background: #f0f2f5; 
        }
        
        #chat-container { 
            width: 100%; 
            max-width: 600px; 
            height: 90vh; 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* Ensure the custom element fills the container */
        openai-chatkit { 
            display: block; 
            height: 100%; 
            width: 100%; 
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .theme-toggle:hover {
            background: rgba(0,0,0,0.08);
            color: #000;
        }
    </style>
</head>
<body>

<button id="theme-btn" class="theme-toggle"></button>

<div id="chat-container">
    <openai-chatkit id="chat"></openai-chatkit>
</div>

<script type="module">
    // 1. Wait for the component to be ready
    await customElements.whenDefined('openai-chatkit');
    const chat = document.getElementById('chat');

    // 2. Identify Unique User (Iframe-safe persistence)
    let userId = localStorage.getItem('chatkit_user_id');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substring(2, 11);
        localStorage.setItem('chatkit_user_id', userId);
    }

    // 3. Mock Data for @-mention Entity Search
    const MOCK_ENTITIES = [
        { id: "order_123", title: "Order #123 (Shipped)", group: "Active Orders", icon: "lucide:package", interactive: true, data: { type: 'order' } },
        { id: "order_456", title: "Order #456 (Processing)", group: "Active Orders", icon: "lucide:clock", interactive: true, data: { type: 'order' } },
        { id: "doc_policy", title: "Return Policy", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } },
        { id: "doc_shipping", title: "Shipping Rates", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } }
    ];

// 4. Define Initial Options
    let currentOptions = {
        api: {
            url: 'http://localhost:8000/chatkit',
            fetch: (url, options) => {
                options.headers = { ...options.headers, 'X-ChatKit-User': userId };
                return fetch(url, options);
            },
            uploadStrategy: { type: 'direct', uploadUrl: 'http://localhost:8000/upload' },
            domainKey: 'local-dev' 
        },
        theme: {
            colorScheme: 'light',
            radius: 'pill',
            typography: {
                baseSize: 16,
                fontFamily: '"OpenAI Sans", system-ui, sans-serif',
                fontFamilyMono: 'ui-monospace, Consolas, monospace',
                fontSources: [
                    {
                        family: 'OpenAI Sans',
                        src: 'https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-Regular.woff2',
                        weight: 400,
                        style: 'normal',
                        display: 'swap'
                    }
                ]
            }
        },
        startScreen: {
            greeting: "Hello! I'm your ProAgent.",
            prompts: [
                { label: "Search AI News", prompt: "Search the web for the latest news on OpenAI ChatKit", icon: "lucide:search" },
                { label: "Analyze Sales", prompt: "Analyze sales performance for North America.", icon: "lucide:bar-chart" },
                { label: "Customize UI", prompt: "I want a new theme. Make it dark mode with a purple neon style and sharp corners.", icon: "lucide:palette" },
                { label: "Check Weather", prompt: "What is the weather in San Francisco?", icon: "lucide:sun" },
                { label: "Generate Image", prompt: "Generate an image of a futuristic city", icon: "lucide:image" },
                { label: "Research AI Models", prompt: "Do a deep research on the latest advancements in AI models and present the report.", icon: "lucide:book-open" }
            ]
        },
        composer: {
            placeholder: "Ask me to search, generate images, or change the UI...",
            dictation: { enabled: true },
            attachments: { enabled: true },
            tools: [
                { id: "web_search", label: "Web Search", icon: "lucide:globe" },
                { id: "get_weather", label: "Weather", icon: "lucide:sun" },
                { id: "preview_theme", label: "Theme Creation", icon: "lucide:paintbrush" }
            ],
            models: [
                { id: "gpt-4o-mini", label: "GPT 4o Mini" , default: true },
                { id: "gpt-5.1", label: "GPT 5.1" }
            ]
        },
        history: {
            enabled: true,
            showDelete: true,
            showRename: true
        },
        threadItemActions: {
            retry: true,
            feedback: true
        },
        entities: {
            showComposerMenu: true,
            onTagSearch: async (query) => {
                const q = query.toLowerCase();
                return MOCK_ENTITIES.filter(e => e.title.toLowerCase().includes(q));
            },
            onClick: (entity) => {
                console.log("User clicked entity:", entity);
            },
            onRequestPreview: async (entity) => {
                // Returns a rich preview widget for the entity
                return {
                    preview: {
                        type: 'Basic',
                        children: [
                            { type: 'Title', value: entity.title, size: 'sm' },
                            { type: 'Text', value: `Database ID: ${entity.id}`, size: 'sm', color: 'secondary' },
                            { type: 'Text', value: "Click to open full records in dashboard.", size: 'xs' }
                        ]
                    }
                };
            }
        }
    };

    // 5. Initialize Chat
    chat.setOptions(currentOptions);

    // Theme Toggle Logic
    const themeBtn = document.getElementById('theme-btn');
    
    function updateThemeState() {
        // If theme is not set, default to light
        const theme = currentOptions.theme || {};
        const isDark = (theme.colorScheme === 'dark');
        const radius = theme.radius || 'lg';
        
        // 1. Handle Icons
        const iconSun = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
        const iconMoon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;

        // 2. Update Toggle Button
        themeBtn.innerHTML = isDark ? iconSun : iconMoon;
        
        if (isDark) {
            themeBtn.style.color = '#ccc';
            themeBtn.onmouseover = () => { themeBtn.style.background = 'rgba(255,255,255,0.1)'; themeBtn.style.color = '#fff'; };
            themeBtn.onmouseout = () => { themeBtn.style.background = 'transparent'; themeBtn.style.color = '#ccc'; };
        } else {
            themeBtn.style.color = '#666';
            themeBtn.onmouseover = () => { themeBtn.style.background = 'rgba(0,0,0,0.08)'; themeBtn.style.color = '#000'; };
            themeBtn.onmouseout = () => { themeBtn.style.background = 'transparent'; themeBtn.style.color = '#666'; };
        }
        
        // 3. Update Page Background
        let bg = isDark ? '#111' : '#f0f2f5';
        
        // If the theme provides granular color controls (from 'preview_theme' tool)
        // We can derive a harmonious background color from the grayscale hue.
        if (theme.color && theme.color.grayscale) {
            const hue = theme.color.grayscale.hue || 210;
            if (isDark) {
                // Dark mode: Very dark desaturated version of the hue
                bg = `hsl(${hue}, 20%, 10%)`;
            } else {
                // Light mode: Very light desaturated version of the hue
                bg = `hsl(${hue}, 20%, 96%)`;
            }
        }
        
        document.body.style.background = bg;

        // 4. Update Container Radius
        const radiusMap = {
            'none': '0px',
            'sharp': '0px',
            '0': '0px',
            'sm': '8px',
            'md': '12px',
            'lg': '16px',
            'xl': '24px',
            'pill': '24px', 
            'full': '32px'
        };
        const containerRadius = radiusMap[radius] || '16px';
        document.getElementById('chat-container').style.borderRadius = containerRadius;
    }

    themeBtn.addEventListener('click', () => {
        const isDark = (currentOptions.theme && currentOptions.theme.colorScheme === 'dark');
        const newScheme = isDark ? 'light' : 'dark';
        
        // Update local options
        currentOptions = {
            ...currentOptions,
            theme: {
                ...currentOptions.theme,
                colorScheme: newScheme
            }
        };
        
        // Apply to ChatKit
        chat.setOptions(currentOptions);
        
        // Update UI
        updateThemeState();
    });

    // Initial check
    updateThemeState();

    // 6. LISTEN FOR CLIENT EFFECTS
    // This allows the server to change the UI look and feel or trigger local logic.
    chat.addEventListener('chatkit.effect', (event) => {
        const { name, data } = event.detail;
        
        if (name === 'update_ui_theme') {
            console.log("Applying theme with typography:", data);
            
            // 1. Update the local configuration object
            currentOptions = {
                ...currentOptions,
                theme: {
                    ...currentOptions.theme, // Preserve existing properties first
                    ...data,                 // Overwrite with new data
                    // If data.typography is present, we might want to be careful, but usually it's an object replacement.
                    // If data.typography is undefined, we keep the old one (via ...currentOptions.theme).
                    // If data.typography is defined, it overwrites.
                    typography: data.typography || currentOptions.theme.typography
                }
            };
            
            // 2. Trigger the SDK update
            chat.setOptions(currentOptions);
            
            // 3. Optional: Force a small layout check to ensure fonts apply
            console.log("Design system refreshed.");

            // 4. Update the toggle button to reflect external changes
            updateThemeState();
        }
    });

    // Optional: Log errors for debugging
    chat.addEventListener('chatkit.error', (e) => {
        console.error("ChatKit Runtime Error:", e.detail.error);
    });

</script>

</body>
</html>